<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四柱推命占い</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <h1>四柱推命占い</h1>
    <form id="fortuneForm">
        <div>
            <label>生年月日</label>
            <select id="year"></select>年
            <select id="month"></select>月
            <select id="day"></select>日
        </div>
        <div>
            <label>性別</label>
            <input type="radio" name="gender" value="male" id="male"><label for="male">男性</label>
            <input type="radio" name="gender" value="female" id="female"><label for="female">女性</label>
        </div>
        <button type="submit">送信</button>
    </form>
    <script>
        async function initializeLiff() {
            try {
                await liff.init({ liffId: 'YOUR_LIFF_ID' });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    const userData = await loadExistingData(profile.userId);
                    populateForm(userData);
                }
            } catch (error) {
                console.error('LIFF initialization failed', error);
            }
        }

        function populateForm(data) {
            if (data) {
                document.getElementById('year').value = data.year || '';
                document.getElementById('month').value = data.month || '';
                document.getElementById('day').value = data.day || '';
                const genderRadio = document.querySelector(`input[name="gender"][value="${data.gender}"]`);
                if (genderRadio) genderRadio.checked = true;
            }
        }

        async function loadExistingData(userId) {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Math.random().toString(36).substring(2);
                window[callbackName] = function (response) {
                    if (response.status === 'success') {
                        resolve(response.userData);
                    } else {
                        reject(response.message || 'データが見つかりませんでした');
                    }
                    delete window[callbackName];
                };

                const script = document.createElement('script');
                script.src = `https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?userId=${userId}&callback=${callbackName}`;
                script.onerror = function () {
                    reject('スクリプトの読み込みに失敗しました');
                };

                document.body.appendChild(script);
            });
        }

        initializeLiff();
    </script>
</body>
</html>
